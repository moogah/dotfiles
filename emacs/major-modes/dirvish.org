#+title: Dirvish Configuration
#+author: Jeff Farr
#+property: header-args:emacs-lisp :tangle dirvish.el
#+auto_tangle: y

* Introduction
This file configures Dirvish, a modern file manager for Emacs that enhances the dired experience.
Dirvish adds features like icons, preview, history, and enhanced navigation while maintaining
dired compatibility.

* Basic Configuration
Setup lexical binding and core Dirvish functionality.

#+begin_src emacs-lisp
;; -*- lexical-binding: t; -*-

;; Core Dirvish setup with specific version
(use-package dirvish
  :straight (dirvish :host github :repo "alexluigit/dirvish" :tag "2.2.3")
  :init
  (dirvish-override-dired-mode)
  :custom
  (dirvish-mode-line-format
   '(:left (sort file-time " " file-size symlink) :right (omit yank index)))
  (dirvish-attributes '(vscode-icon file-size collapse subtree-state vc-state))
  :config
  ;; Platform-specific settings
  (when (string= system-type "darwin")
    (setq dired-use-ls-dired nil))
  
  ;; Listing options
  (setq dired-dwim-target t)  ;; enable side-by-side copy/move
  (setq delete-by-moving-to-trash t)
  
  ;; Reserved for Emacs 29
  ;;(setq dired-mouse-drag-files t)
  ;;(setq mouse-drag-and-drop-region-cross-program t)
  
  ;; Configure ls display options
  (setq dired-listed-switches
        "-l --almost-all --human-readable --time-style=long-iso --group-directories-first --no-group")
  
  ;; Prevent buffer proliferation when navigating
  (setf dired-kill-when-opening-new-dired-buffer t))
#+end_src

* Quick Access Entries
Configure the quick access menu for fast navigation to common directories.

#+begin_src emacs-lisp
;; Define quick access directories
(setq dirvish-quick-access-entries
 '(("h" "~/"              "Home")
   ("s" "~/src/"          "Source Code")
   ("d" "~/src/dotfiles"  "Dotfiles")
   ("e" "~/.emacs.d/"     "Emacs Config")
   ("o" "~/org/"          "Org")
   ("l" "~/src/homelab/"  "Homelab")))
#+end_src

* Icon Support
Configure vscode-icon for visual file type identification.

#+begin_src emacs-lisp
;; Use VS Code icons for a nicer visual experience
(use-package vscode-icon
  :straight t
  :config
  (setq dirvish-vscode-icon-size 18))
#+end_src

* Additional Dired Settings
Configure additional dired settings that integrate with Dirvish.

#+begin_src emacs-lisp
;; Enable editing of dired buffers with 'C-x C-q'
(put 'dired-find-alternate-file 'disabled nil)

;; Automatically update dired buffers when state-on-disk changes
(add-hook 'dired-mode-hook 'auto-revert-mode)
#+end_src

* Keybindings
Configure Vim-style navigation and other useful keybindings.

#+begin_src emacs-lisp
;; Global and mode-specific keybindings
(with-eval-after-load 'dirvish
  ;; Global keys
  (global-set-key (kbd "C-x d") 'dired-jump)
  (global-set-key (kbd "C-c f") 'dirvish-fd)
  
  ;; Dirvish mode keys - Vim-style navigation
  (define-key dirvish-mode-map (kbd "h") 'dired-up-directory)
  (define-key dirvish-mode-map (kbd "j") 'dired-next-line)
  (define-key dirvish-mode-map (kbd "k") 'dired-previous-line)
  (define-key dirvish-mode-map (kbd "l") 'dired-find-file)
  
  ;; Editing and view controls
  (define-key dirvish-mode-map (kbd "i") 'wdired-change-to-wdired-mode)
  (define-key dirvish-mode-map (kbd ".") 'dired-omit-mode)
  
  ;; Navigation and utility
  (define-key dirvish-mode-map (kbd "b") 'dirvish-quick-access)
  (define-key dirvish-mode-map (kbd "f") 'dirvish-file-info-menu)
  (define-key dirvish-mode-map (kbd "y") 'dirvish-yank-menu)
  (define-key dirvish-mode-map (kbd "N") 'dirvish-narrow)
  (define-key dirvish-mode-map (kbd "/") 'dired-isearch-filenames)
  (define-key dirvish-mode-map (kbd "^") 'dirvish-history-last)
  (define-key dirvish-mode-map (kbd "H") 'dirvish-history-jump)
  (define-key dirvish-mode-map (kbd "s") 'dirvish-quicksort)
  (define-key dirvish-mode-map (kbd "TAB") 'dirvish-subtree-toggle)
  
  ;; Advanced operations with Meta key
  (define-key dirvish-mode-map (kbd "M-n") 'dirvish-history-go-forward)
  (define-key dirvish-mode-map (kbd "M-p") 'dirvish-history-go-backward)
  (define-key dirvish-mode-map (kbd "M-l") 'dirvish-ls-switches-menu)
  (define-key dirvish-mode-map (kbd "M-m") 'dirvish-mark-menu)
  (define-key dirvish-mode-map (kbd "M-f") 'dirvish-toggle-fullscreen)
  (define-key dirvish-mode-map (kbd "M-s") 'dirvish-setup-menu)
  (define-key dirvish-mode-map (kbd "M-e") 'dirvish-emerge-menu)
  (define-key dirvish-mode-map (kbd "M-j") 'dirvish-fd-jump))
#+end_src
