#+title: LLM/AI Integration Configuration
#+author: Jeff Farr
#+property: header-args:emacs-lisp :tangle gpt.el
#+auto_tangle: y

* Introduction
This file configures various large language model (LLM) and AI integrations for Emacs,
including OpenAI GPT, Anthropic Claude, and Perplexity models. It sets up interactive
shells, buffers, and tools for working with these AI assistants.

* Basic Configuration
Setup lexical binding for better closures and variable scoping.

#+begin_src emacs-lisp
;; -*- lexical-binding: t; -*-
#+end_src

* ChatGPT Shell
Configure Xenodium's ChatGPT shell for a conversational interface with OpenAI models.

#+begin_src emacs-lisp
;;  (use-package shell-maker
;;    :straight (shell-maker :type git :host github :repo "xenodium/shell-maker" :files ("shell-maker.el")))
;;
;;  ; add :build (:not compile) if byte code has problems
;;  (use-package chatgpt-shell
;;    :requires shell-maker
;;    :straight (:host github :repo "xenodium/chatgpt-shell" :files ("*.el") :build (:not compile)))
;;
;;  (setq chatgpt-shell-openai-key
;;        (lambda ()
;;          (auth-source-pick-first-password :host "api.openai.com")))
;;
;;  ;;(setq chatgpt-shell-model-version "gpt-4o")
#+end_src

* GPTEL
Configure gptel, a versatile LLM client with support for multiple models and providers.

** Authentication Setup
This configuration uses =.authinfo.gpg= to securely store API keys. Create or edit
=~/.authinfo.gpg= with entries in the following format:

#+begin_example
machine api.openai.com login apikey password YOUR_OPENAI_API_KEY
machine api.anthropic.com login apikey password YOUR_ANTHROPIC_API_KEY
machine api.perplexity.ai login apikey password YOUR_PERPLEXITY_API_KEY
#+end_example

Notes:
- Each entry should be on a single line
- The =machine= field corresponds to the =:host= parameter in the config
- The =login= field can be any value (commonly "apikey" for API services)
- The =password= field contains your actual API key
- Save the file and GPG will encrypt it automatically if it has the =.gpg= extension
- You may need to enter your GPG passphrase when Emacs first accesses the file

** GPTEL Configuration

#+begin_src emacs-lisp
  (use-package gptel
    :straight t
    :custom
    (gptel-model 'gpt-4o) ;; model is now a symbol, not a string
    :config
    ;; Configure Perplexity backend
    (gptel-make-perplexity "Perplexity"
      :key (lambda () (auth-source-pick-first-password :host "api.perplexity.ai"))
      :stream t)
    
    ;; Configure Anthropic backend for Claude Sonnet
    (gptel-make-anthropic "Claude"
      :stream t
      :key (lambda () (auth-source-pick-first-password :host "api.anthropic.com")))
    
    ;; Configure Anthropic backend for Claude 3.7 Sonnet with thinking mode
    (gptel-make-anthropic "Claude-thinking"
      :key (lambda () (auth-source-pick-first-password :host "api.anthropic.com"))
      :stream t
      :models '(claude-3-7-sonnet-20250219)
      :header (lambda ()
                (let ((key (gptel--get-api-key
                            ;; Explicitly use the same key function as defined above
                            (lambda () (auth-source-pick-first-password :host "api.anthropic.com")))))
                  `(("x-api-key" . ,key)
                    ("anthropic-version" . "2023-06-01")
                    ("anthropic-beta" . "pdfs-2024-09-25")
                    ("anthropic-beta" . "output-128k-2025-02-19")
                    ("anthropic-beta" . "prompt-caching-2024-07-31"))))
      :request-params '(:thinking (:type "enabled" :budget_tokens 2048)
                        :max_tokens 4096))

    ;; Configure ChatGPT/OpenAI backend
    (gptel-make-openai "ChatGPT"
      :key (lambda () (auth-source-pick-first-password :host "api.openai.com"))
      :stream t
      :models '(gpt-4o gpt-4o-mini gpt-4-turbo gpt-3.5-turbo)))
#+end_src

* GPTEL Tools
Define custom tools and functions that can be used by LLMs to interact with the Emacs environment.

#+begin_src emacs-lisp
  (gptel-make-tool
   :name "create_file"                    ; javascript-style  snake_case name
   :function (lambda (path filename content)   ; the function that runs
               (let ((full-path (expand-file-name filename path)))
                 (with-temp-buffer
                   (insert content)
                   (write-file full-path))
                 (format "Created file %s in %s" filename path)))
   :description "Create a new file with the specified content"
   :args (list '(:name "path"             ; a list of argument specifications
                 :type string
                 :description "The directory where to create the file")
               '(:name "filename"
                 :type string
                 :description "The name of the file to create")
               '(:name "content"
                 :type string
                 :description "The content to write to the file"))
   :category "filesystem")                ; An arbitrary label for grouping
#+end_src

* GPTEL Session Launchers
Quick launcher functions for starting dedicated gptel sessions with specific models.
These functions create or switch to named buffers with pre-configured backends and models.

#+begin_src emacs-lisp
(defun jf/gptel-gpt4o ()
  "Launch gptel session with GPT-4o in a dedicated buffer."
  (interactive)
  (let ((backend (alist-get "ChatGPT" gptel--known-backends nil nil #'equal))
        (model 'gpt-4o))
    (pop-to-buffer (gptel "*gptel-gpt4o*" nil nil t))
    (setq-local gptel-backend backend)
    (setq-local gptel-model model)))

(defun jf/gptel-gpt4o-mini ()
  "Launch gptel session with GPT-4o-mini in a dedicated buffer."
  (interactive)
  (let ((backend (alist-get "ChatGPT" gptel--known-backends nil nil #'equal))
        (model 'gpt-4o-mini))
    (pop-to-buffer (gptel "*gptel-gpt4o-mini*" nil nil t))
    (setq-local gptel-backend backend)
    (setq-local gptel-model model)))

(defun jf/gptel-claude-thinking ()
  "Launch gptel session with Claude Sonnet (extended thinking) in a dedicated buffer."
  (interactive)
  (let ((backend (alist-get "Claude-thinking" gptel--known-backends nil nil #'equal))
        (model 'claude-3-7-sonnet-20250219))
    (pop-to-buffer (gptel "*gptel-claude-thinking*" nil nil t))
    (setq-local gptel-backend backend)
    (setq-local gptel-model model)))

(defun jf/gptel-perplexity ()
  "Launch gptel session with Perplexity in a dedicated buffer."
  (interactive)
  (let ((backend (alist-get "Perplexity" gptel--known-backends nil nil #'equal))
        (model 'sonar))
    (pop-to-buffer (gptel "*gptel-perplexity*" nil nil t))
    (setq-local gptel-backend backend)
    (setq-local gptel-model model)))

;; Keybindings for gptel launchers
;; Uses <SPC> l prefix (l for LLM)
(with-eval-after-load 'gptel
  ;; Define prefix command map for LLM launchers
  (define-prefix-command 'jf/gptel-launcher-map)
  (evil-define-key 'normal 'global (kbd "<SPC> l") 'jf/gptel-launcher-map)

  ;; Individual launcher bindings
  (define-key jf/gptel-launcher-map (kbd "4") 'jf/gptel-gpt4o)
  (define-key jf/gptel-launcher-map (kbd "m") 'jf/gptel-gpt4o-mini)
  (define-key jf/gptel-launcher-map (kbd "c") 'jf/gptel-claude-thinking)
  (define-key jf/gptel-launcher-map (kbd "p") 'jf/gptel-perplexity))
#+end_src

** Usage
Launch dedicated LLM sessions with:
- =<SPC> l 4= - GPT-4o (ChatGPT flagship model)
- =<SPC> l m= - GPT-4o-mini (ChatGPT fast model)
- =<SPC> l c= - Claude 3.7 Sonnet with extended thinking
- =<SPC> l p= - Perplexity

Each launcher creates or switches to a dedicated buffer, allowing multiple
concurrent sessions with different models.

* Elysium
Setup Elysium, a streamlined interface for using Claude models from Emacs.

#+begin_src emacs-lisp
  (use-package elysium
    :straight (:host github :repo "lanceberge/elysium" :branch "main" :files ("*.el")))
#+end_src

